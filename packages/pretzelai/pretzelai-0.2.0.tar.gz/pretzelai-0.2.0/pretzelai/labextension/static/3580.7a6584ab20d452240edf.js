"use strict";(self.webpackChunkpretzelai=self.webpackChunkpretzelai||[]).push([[3580],{3580:(e,t,n)=>{n.r(t),n.d(t,{default:()=>m});var o=n(8440),r=n(2506),i=n(8394),l=n(5007),s=n.n(l),a=n(9500),d=n(8640);async function c(e){const t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")}const u="text-embedding-3-large",p={id:"pretzelai:plugin",autoStart:!0,requires:[o.ICommandPalette,r.INotebookTracker,a.ISettingRegistry],activate:async(e,t,n,o)=>{const{commands:r}=e,l="pretzelai:replace-code",a="To use AI features, please set your OpenAI API key or Azure API details in the Pretzel AI Settings.\nYou can also use the free Pretzel AI server.\nGo To: Settings > Settings Editor > Pretzel AI Settings to configure",m="Ask AI. Use @variableName to refernce defined variables and dataframes";let g,h,y="",b="",x="OpenAI API key",f="",v="",k="";function w(e){o.load(p.id).then((t=>{y=t.get("openAiSettings").composite.openAiApiKey,x=t.get("aiService").composite,b=t.get("openAiSettings").composite.openAiBaseUrl,f=t.get("azureSettings").composite.azureBaseUrl,v=t.get("azureSettings").composite.azureDeploymentName,k=t.get("azureSettings").composite.azureApiKey,null==e||e()})).catch((e=>{console.error("Failed to load settings for Pretzel",e)}))}async function C(t,n,o){let r=!1;h=t;const i=n.map((e=>(async()=>{const t=h.findIndex((t=>t.id===e.id));if(-1!==t){const n=await c(e.source);if(n!==h[t].hash)try{console.log("Hash changed: creating embedding for cell ",e.id),r=!0;const o=await g.embeddings.create({model:u,input:e.source});h[t]={id:e.id,source:e.source,hash:n,embedding:o.data[0].embedding}}catch(e){console.error("Error generating embedding:",e)}}else{console.log("New cell: creating embedding for cell ",e.id),r=!0;try{const t=await g.embeddings.create({model:u,input:e.source}),n=await c(e.source);h.push({id:e.id,source:e.source,hash:n,embedding:t.data[0].embedding})}catch(e){console.error("Error generating embedding:",e)}}})()));await Promise.allSettled(i),r&&e.serviceManager.contents.save(o,{type:"file",format:"text",content:JSON.stringify(h)})}async function A(e){var t;const o=n.currentWidget;if(!o||!(null===(t=o.sessionContext.session)||void 0===t?void 0:t.kernel))return console.error("No active kernel found"),null;{const t=o.sessionContext.session.kernel;try{const n=t.requestExecute({code:`print(${e})`});let o=null;t.registerMessageHook(n.msg.header.msg_id,(e=>("stream"===e.header.msg_type&&"stdout"===e.content.name&&(o=e.content.text.trim()),!0)));const r=await n.done;return r&&"ok"===r.content.status?o:(console.error("Failed to retrieve variable value"),null)}catch(e){return console.error("Error retrieving variable value:",e),null}}}w(),function e(){y?g=new(s())({apiKey:y,dangerouslyAllowBrowser:!0}):setTimeout(e,1e3)}(),o.pluginChanged.connect(((e,t)=>{t===p.id&&w((async()=>{const e=document.querySelector(".pretzelInputSubmitButton"),t=document.querySelector(".pretzelInputField");e&&("OpenAI API key"===x&&y||"Use Pretzel AI Server"===x||"Use Azure API"===x&&f&&v&&k?(e.disabled=!1,t.placeholder=m):(e.disabled=!0,t.placeholder=a))}))})),function t(){const o=n.currentWidget;if((null==o?void 0:o.model)&&g){const n=o.context.path.replace(".ipynb","")+"_embeddings.json";e.serviceManager.contents.get(n).then((e=>{try{C(JSON.parse(e.content),o.model.sharedModel.cells,n)}catch(e){console.error("Error parsing embeddings JSON:",e)}})).catch((async e=>{C([],o.model.sharedModel.cells,n)})),setTimeout(t,1e3)}else setTimeout(t,1e3)}(),r.addCommand(l,{label:"Replace Cell Code",execute:()=>{const e=n.activeCell;if(e){const t=e.node.querySelector(".pretzelParentContainerAI");if(t)return t.remove(),void e.editor.focus();const o=e.model.sharedModel.source,l=document.createElement("div");l.classList.add("pretzelParentContainerAI"),e.node.appendChild(l);const c=document.createElement("div");c.style.marginTop="10px",c.style.marginLeft="70px",c.style.display="flex",c.style.flexDirection="column",l.appendChild(c);const p=document.createElement("textarea");p.classList.add("pretzelInputField"),p.placeholder=m,p.style.width="100%",p.style.height="100px",c.appendChild(p),p.addEventListener("keydown",(e=>{if("Escape"===e.key){e.preventDefault();const t=n.activeCell;t&&t.editor&&t.editor.focus()}"Enter"===e.key&&(e.preventDefault(),w.disabled||E())}));const g=document.createElement("div");g.style.marginTop="10px",g.style.display="flex",g.style.flexDirection="row",c.appendChild(g),p.focus();const w=document.createElement("button");w.classList.add("pretzelInputSubmitButton"),w.textContent="Submit",w.style.backgroundColor="lightblue",w.style.borderRadius="5px",w.style.border="1px solid darkblue",w.style.maxWidth="100px",w.style.minHeight="25px",w.style.marginTop="10px",w.style.marginRight="10px",g.appendChild(w);const C=document.createElement("button");C.textContent="Remove",C.style.backgroundColor="lightcoral",C.style.borderRadius="5px",C.style.border="1px solid darkred",C.style.maxWidth="100px",C.style.minHeight="25px",C.style.marginTop="10px",g.appendChild(C),C.addEventListener("click",(()=>{e.node.removeChild(l)})),("OpenAI API key"!==x||y)&&("Use Azure API"!==x||f&&v&&k)||(p.placeholder=a,w.disabled=!0);const E=async()=>{let t=p.value;if(""!==t){l.removeChild(c);let n=null;const a=e=>{try{n||p();const t=n.getModel().modified,o=t.getLineCount(),r=t.getLineMaxColumn(o);t.applyEdits([{range:new i.Range(o,r,o,r),text:e,forceMoveMarkers:!0}])}catch(e){console.log("Error rendering editor:",e)}},p=()=>{const t=document.createElement("div");t.style.marginTop="10px",t.style.display="flex",t.style.flexDirection="column",l.appendChild(t);const s=document.createElement("div");s.style.height="200px",t.appendChild(s);const a="true"===document.body.getAttribute("data-jp-theme-light")?"vs":"vs-dark";n=i.editor.createDiffEditor(s,{readOnly:!0,theme:a}),n.setModel({original:i.editor.createModel(o,"python"),modified:i.editor.createModel("","python")});const d=document.createElement("div");d.style.marginTop="10px",d.style.marginLeft="70px",d.style.display="flex",d.style.flexDirection="row",t.appendChild(d);const u=document.createElement("button");u.textContent="Accept",u.style.backgroundColor="lightblue",u.style.borderRadius="5px",u.style.border="1px solid darkblue",u.style.maxWidth="100px",u.style.minHeight="25px",u.style.marginRight="10px",u.addEventListener("click",(()=>{const t=n.getModel().modified.getValue();e.model.sharedModel.source=t,r.execute("notebook:run-cell"),e.node.removeChild(l)})),d.appendChild(u);const p=document.createElement("button");p.textContent="Reject",p.style.backgroundColor="lightblue",p.style.borderRadius="5px",p.style.border="1px solid darkblue",p.style.maxWidth="100px",p.style.minHeight="25px",p.style.marginRight="10px",p.addEventListener("click",(()=>{e.node.removeChild(l),e.model.sharedModel.source=o})),d.appendChild(p);const m=document.createElement("button");m.textContent="Edit Prompt",m.style.backgroundColor="lightblue",m.style.borderRadius="5px",m.style.border="1px solid darkblue",m.style.maxWidth="100px",m.style.minHeight="25px",m.style.marginRight="10px",m.addEventListener("click",(()=>{l.removeChild(t),l.appendChild(c),n=null})),d.appendChild(m),d.addEventListener("keydown",(e=>{if("Enter"===e.key){e.preventDefault();const t=document.activeElement;t===u?u.click():t===p&&p.click()}})),d.addEventListener("keydown",(e=>{"Escape"===e.key&&(e.preventDefault(),p.click())}))},m=/@(\w+)/g;let g,w=t;for(;null!==(g=m.exec(t));)try{const e=g[1],t=await A(`type(${e})`);(null==t?void 0:t.includes("DataFrame"))?w+=`\n${e} is a dataframe with the following columns: ${await A(`${e}.columns`)}\n`:t&&(w+=`\nPrinting ${e} in Python returns the string ${await A(e)}\n`)}catch(e){console.error(`Error accessing variable ${g[1]}:`,e)}if(t=w,"OpenAI API key"===x&&y)try{const e=new(s())({apiKey:y,dangerouslyAllowBrowser:!0,baseURL:b||void 0}),n=async()=>{var n,r;const i=(await e.embeddings.create({model:u,input:t})).data[0].embedding,l=h.map((e=>{return t=e.embedding,n=i,t.reduce(((e,t,o)=>e+t*n[o]),0)/(Math.sqrt(t.reduce(((e,t)=>e+t*t),0))*Math.sqrt(n.reduce(((e,t)=>e+t*t),0)));var t,n})).map(((e,t)=>({value:e,index:t}))).sort(((e,t)=>t.value-e.value)).slice(0,3).map((e=>h[e.index].source)),s=function(e,t,n){return`The user wants to do the following:\n"""\n${e}\n"""\n\n${t?`The following code already exists in the notebook cell:\n"""\n${t}\n"""\n\n`:""}\n${n.length>0?`We also have the following matching code chunks in the notebook\n---\n${n.join("\n---\n")}\n---\n`:""}\nBased on the above, return ONLY executable python code, no backticks.`}(t,o,l);console.log(s);const d=await e.chat.completions.create({model:"gpt-4-turbo-preview",messages:[{role:"system",content:"You are a helpful assistant that helps users write python code in Jupyter notebook cells. You are helping the user write new code and edit old code in Jupyter notebooks. You write code exactly as if an expert python user would write, reusing existing variables and functions as needed. You respond with the clean, good quality, working python code only, no backticks."},{role:"user",content:s}],stream:!0});for await(const e of d)a((null===(r=null===(n=e.choices[0])||void 0===n?void 0:n.delta)||void 0===r?void 0:r.content)||"")};n()}catch(t){e.node.removeChild(l)}else if("Use Pretzel AI Server"===x){const n={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldCode:o,userInput:t})};try{const e=await fetch("https://q8qeei2tn4.execute-api.us-west-1.amazonaws.com/default/pretzel_notebook",n),t=(await e.json()).message;a(t)}catch(t){e.model.sharedModel.source=`# Error: ${t}\n${o}`,e.node.removeChild(l)}}else if("Use Azure API"===x&&f&&v&&k)try{const e=new d.OpenAIClient(f,new d.AzureKeyCredential(k)),n=v,r=[`Write python code to do \n"""\n${t}\n"""\nThe previous code is\n"""\n${o}\n"""\nReturn ONLY executable python code, no backticks`],i=await e.getCompletions(n,r);for(const e of i.choices)a(e.text)}catch(t){e.model.sharedModel.source=`# Error: ${t}\n${o}`,e.node.removeChild(l)}}};w.addEventListener("click",E)}}}),t.addItem({command:l,category:"Cell Operations"}),e.commands.addKeyBinding({command:l,keys:["Accel K"],selector:".jp-Notebook"})}},m=p}}]);