"use strict";(self.webpackChunkhslayers_cesium_app=self.webpackChunkhslayers_cesium_app||[]).push([[557],{78557:(ye,P,s)=>{s.r(P),s.d(P,{HsTripPlannerComponent:()=>de,HsTripPlannerLayerSelectorComponent:()=>G,HsTripPlannerModule:()=>ue,HsTripPlannerService:()=>L,getWaypoint:()=>N,setWaypoint:()=>re});var e=s(68559),m=s(89204),O=s(5342),U=s(72354),V=s(61318),D=s(59452),Y=s(16613),X=s(94691),b=s(77662),B=s(36758),z=(s(29814),s(18194),s(1963),s(57690),s(2844),s(66586)),Q=s(49964),C=s(53848),x=s(60411),F=s(45363),y=s(88716),E=s(14608),f=s(27426),Z=s(46443),q=s(56287),_=s(22187),ee=s(78373),M=s(91459),te=s(24025),A=s(40736);const W="wp";function re(i,p){i.set(W,p)}function N(i){return i.get(W)}let L=(()=>{class i{constructor(t,r,n,a,o,l,S,d,H,T){this.HsMapService=t,this.HsUtilsService=r,this.$http=n,this.HsShareUrlService=a,this.HsEventBusService=o,this.HsToastService=l,this.HsLanguageService=S,this.HsLayerUtilsService=d,this.HsLayoutService=H,this.hsConfig=T,this.waypoints=[],this.trip={},this.movable_features=new Y.A,this.selectedLayerWrapper={},this.modify=new b.A({features:this.movable_features}),this.HsEventBusService.mapClicked.subscribe(u=>{"tripPlanner"==this.HsLayoutService.mainpanel&&(this.waypointLayer||this.createWaypointLayer(),this.routeLayer||this.createRouteLayer(),!this.HsMapService.getMap().getInteractions().getArray().find(h=>h.getActive()&&this.HsUtilsService.instOf(h,B.Ay))&&this.addWaypoint({x:u.mapProjCoordinate[0],y:u.mapProjCoordinate[1],lon:u.epsg4326Coordinate[0],lat:u.epsg4326Coordinate[1]}))}),this.HsMapService.loaded().then(u=>{u.addInteraction(this.modify),this.fillVectorLayers()})}fillVectorLayers(){var t=this;return(0,m.A)(function*(){t.HsMapService.loaded().then(r=>{t.vectorLayers=[{layer:null,title:"newLayer"},...t.HsMapService.getLayersArray().filter(n=>t.HsLayerUtilsService.isLayerDrawable(n)).map(n=>({layer:n,title:(0,y.LK)(n)}))],t.fillDefaultLayerWrapper("route"),t.fillDefaultLayerWrapper("waypoints")})})()}fillDefaultLayerWrapper(t){this.selectedLayerWrapper[t]=this.selectedLayerWrapper[t]?this.vectorLayers.find(r=>r.layer==this.selectedLayerWrapper[t].layer):this.vectorLayers[0]}createWaypointLayer(){this.waypointSource=new x.A,this.waypointLayer=new C.A({source:this.waypointSource,style:this.waypointRouteStyle}),(0,y.D6)(this.waypointLayer,this.HsLanguageService.getTranslation("TRIP_PLANNER.waypoints",void 0)),this.HsMapService.getMap().addLayer(this.waypointLayer)}createRouteLayer(){this.routeSource=new x.A,this.routeLayer=new C.A({source:this.routeSource,style:this.waypointRouteStyle}),(0,y.D6)(this.routeLayer,this.HsLanguageService.getTranslation("TRIP_PLANNER.travelRoute",void 0)),this.HsMapService.getMap().addLayer(this.routeLayer)}selectLayer(t,r){var n=this;return(0,m.A)(function*(){if("route"==r&&(n.routeLayer=t.layer,n.routeLayer&&(n.routeSource=n.routeLayer.getSource()),n.selectedLayerWrapper.route=t),"waypoints"==r){n.waypointLayer=t.layer,n.waypointLayer&&(n.waypointSource=n.waypointLayer.getSource()),n.routeSource.clear(),n.waypoints.length=0,n.selectedLayerWrapper.waypoints=t;for(const a of n.waypointSource.getFeatures()){const o=(0,F.transform)(a.getGeometry().getCoordinates(),n.HsMapService.getCurrentProj().getCode(),"EPSG:4326"),l={lon:o[0],lat:o[1],name:"Waypoint "+(n.waypoints.length+1),hash:n.HsUtilsService.hashCode(JSON.stringify("Waypoint "+n.waypoints.length+Math.random())),routes:{from:null,to:null},featureId:a.getId(),loading:!1};n.waypoints.push(l),void 0!==n.waypointAdded&&n.waypointAdded(l),yield n.calculateRoutes()}}})()}getTextOnFeature(t){let r="";const n=N(t);return n&&(r=n.name,n?.routes?.to&&(r+=` (${this.formatDistance(n,"to")})`)),r}addWaypoint({x:t,y:r,lon:n,lat:a}){const o={lon:n,lat:a,name:"Waypoint "+(this.waypoints.length+1),hash:this.HsUtilsService.hashCode(JSON.stringify("Waypoint "+this.waypoints.length+Math.random())),routes:{from:null,to:null},featureId:null,loading:!1},l=new X.default({wp:o,geometry:new Q.default([t,r]),id:this.HsUtilsService.generateUuid()});l.setId(l.get("id")),o.featureId=l.getId(),this.waypointSource.addFeature(l),this.waypoints.push(o),void 0!==this.waypointAdded&&this.waypointAdded(o),this.calculateRoutes()}waypointAdded(t){const r=this.waypointSource.getFeatureById(t.featureId);this.movable_features.push(r),r.getGeometry().on("change",n=>{this.removeRoutesForWaypoint(t);const a=(0,F.transform)(r.getGeometry().getCoordinates(),this.HsMapService.getCurrentProj().getCode(),"EPSG:4326");t.lon=a[0],t.lat=a[1];const o=this.waypoints.indexOf(t)-1;o>-1&&(this.waypoints[o].routes.from=null,this.routeRemoved(this.waypoints[o].routes.from)),null!==this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.calculateRoutes()},500)})}routeRemoved(t){try{t&&this.routeSource.removeFeature(t)}catch(r){throw r}}removeRoutesForWaypoint(t){this.routeRemoved(t.routes.from),this.routeRemoved(t.routes.to),t.routes={from:null,to:null}}waypointRemoved(t){try{this.waypointSource.removeFeature(this.waypointSource.getFeatureById(t.featureId))}catch(r){throw r}}removeWaypoint(t){const r=this.waypoints.indexOf(t),n=r-1;n>-1&&(this.waypoints[n].routes.from=null),this.routeRemoved(t.routes.from),this.routeRemoved(t.routes.to);const a=r+1;a<this.waypoints.length&&(this.waypoints[a].routes.to=null),this.waypointRemoved(t),this.waypoints.splice(this.waypoints.indexOf(t),1),this.calculateRoutes()}clearAll(){this.waypoints=[],this.waypointSource.clear(),this.routeSource.clear()}routeAdded(t){this.routeSource.addFeatures(t)}calculateRoutes(){var t=this;return(0,m.A)(function*(){for(let r=0;r<t.waypoints.length-1;r++){const n=t.waypoints[r];if(null===n.routes.from){const a=t.waypoints[r+1];a.loading=!0;const o=t.HsUtilsService.proxify("https://api.openrouteservice.org/v2/directions/driving-car/geojson"),l=yield(0,O.s)(t.$http.post(o,{coordinates:[[n.lon,n.lat],[a.lon,a.lat]]}).pipe((0,U.w)(1e4),(0,V.W)(H=>{let T=t.HsLanguageService.getTranslation("TRIP_PLANNER.serviceDown",void 0);return 404==H.status&&(T=t.HsLanguageService.getTranslation("TRIP_PLANNER.missingAuth",void 0)),t.HsToastService.createToastPopupMessage(T,t.HsLanguageService.getTranslationIgnoreNonExisting("ERRORMESSAGES",H.message,{url:o}),{disableLocalization:!0,serviceCalledFrom:"HsTripPlannerService"}),(0,D.of)(null)})));if(!l)return;a.loading=!1;const d=(new z.default).readFeatures(l);d[0].getGeometry().transform("EPSG:4326",t.HsMapService.getCurrentProj()),n.routes.from=d[0],a.routes.to=d[0],void 0!==t.routeAdded&&t.routeAdded(d)}}})()}formatDistance(t,r){if(t.routes[r=void 0!==r?r:"from"]){const a=t.routes[r]?.get("summary").distance/1e3;return null==a?"":a.toFixed(2)+"km"}}static#e=this.\u0275fac=function(r){return new(r||i)(e.KVO(E.F),e.KVO(f.MJ),e.KVO(Z.Qq),e.KVO(q.HsShareUrlService),e.KVO(_.z),e.KVO(ee.ST),e.KVO(M.LJ),e.KVO(f.Xp),e.KVO(te.F),e.KVO(A.Q))};static#t=this.\u0275prov=e.jDH({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var c=s(60316),v=s(20572),j=s(31968);const ne=i=>({show:i}),R=()=>({module:"LAYERS"});function ie(i,p){if(1&i&&(e.j41(0,"div",8),e.EFF(1),e.nI1(2,"translateHs"),e.k0s()),2&i){const t=e.XpG();e.R7$(),e.SpI(" ",e.i5U(2,1,t.selectedWrapper.title,e.lJ4(4,R))," ")}}function se(i,p){if(1&i){const t=e.RV6();e.j41(0,"a",9),e.nI1(1,"translateHs"),e.bIt("click",function(){const n=e.eBV(t).$implicit,a=e.XpG();return a.HsTripPlannerService.selectLayer(n,a.usage),e.Njj(a.layersExpanded=!1)}),e.EFF(2),e.nI1(3,"translateHs"),e.k0s()}if(2&i){const t=p.$implicit;e.Y8G("title",e.i5U(1,2,t.title,e.lJ4(8,R))),e.R7$(2),e.JRh(e.i5U(3,5,t.title,e.lJ4(9,R)))}}let G=(()=>{class i{constructor(t,r){this.HsTripPlannerService=t,this.HsLayerUtilsService=r}static#e=this.\u0275fac=function(r){return new(r||i)(e.rXU(L),e.rXU(f.Xp))};static#t=this.\u0275cmp=e.VBU({type:i,selectors:[["hs-trip-planner-layer-selector"]],inputs:{label:"label",usage:"usage",selectedWrapper:"selectedWrapper"},decls:9,vars:7,consts:[[1,"flex-row","w-100","m-auto","justify-content-center","align-items-center",2,"display","flex"],[1,"m-0","p-0","flex-fill","text-primary"],["ngbDropdown","","placement","bottom",2,"max-width","50%"],["type","button","ngbDropdownToggle","","aria-haspopup","true",1,"btn","btn-sm","rounded-0","hs-toolbar-button","d-flex","align-items-center","mw-100",3,"click"],["class","text-truncate",4,"ngIf"],["ngbDropdownMenu","",2,"transform","translateX(25%)","width","15em",3,"ngClass"],[1,"d-flex","align-items-center","w-100","flex-column"],["class","dropdown-item text-truncate","data-toggle","tooltip",3,"title","click",4,"ngFor","ngForOf"],[1,"text-truncate"],["data-toggle","tooltip",1,"dropdown-item","text-truncate",3,"click","title"]],template:function(r,n){1&r&&(e.j41(0,"div",0)(1,"p",1),e.EFF(2),e.k0s(),e.j41(3,"div",2)(4,"button",3),e.bIt("click",function(){return n.layersExpanded=!n.layersExpanded,n.HsTripPlannerService.fillVectorLayers()}),e.DNE(5,ie,3,5,"div",4),e.k0s(),e.j41(6,"div",5)(7,"div",6),e.DNE(8,se,4,10,"a",7),e.k0s()()()()),2&r&&(e.R7$(2),e.SpI("",n.label,":"),e.R7$(2),e.BMQ("aria-expanded",n.layersExpanded),e.R7$(),e.Y8G("ngIf",void 0!==n.selectedWrapper),e.R7$(),e.Y8G("ngClass",e.eq3(5,ne,n.layersExpanded)),e.R7$(2),e.Y8G("ngForOf",n.HsTripPlannerService.vectorLayers))},dependencies:[c.YU,c.Sq,c.bT,v.tg,v.do,v.U0,j.q],encapsulation:2})}return i})();var $=s(25849),ae=s(17232),g=s(34456);const oe=()=>({standalone:!0});function le(i,p){if(1&i){const t=e.RV6();e.j41(0,"div",9)(1,"div",10)(2,"a",12),e.bIt("click",function(){const n=e.eBV(t).$implicit,a=e.XpG(2);return e.Njj(a.toggleEdit(n))}),e.EFF(3),e.k0s(),e.j41(4,"input",13),e.mxI("ngModelChange",function(n){const a=e.eBV(t).$implicit;return e.DH7(a.name,n)||(a.name=n),e.Njj(n)}),e.bIt("blur",function(){const n=e.eBV(t).$implicit,a=e.XpG(2);return e.Njj(a.toggleEdit(n))}),e.k0s()(),e.j41(5,"div",11),e.nrm(6,"span",14),e.k0s(),e.j41(7,"div",15)(8,"div",16),e.EFF(9),e.k0s()(),e.j41(10,"div",11)(11,"a",17),e.nI1(12,"translateHs"),e.bIt("click",function(){const n=e.eBV(t).$implicit,a=e.XpG(2);return e.Njj(a.HsTripPlannerService.removeWaypoint(n))}),e.nrm(13,"i",18),e.k0s()()()}if(2&i){const t=p.$implicit,r=e.XpG(2);e.R7$(2),e.Y8G("hidden",!!t.editMode),e.R7$(),e.JRh(t.name),e.R7$(),e.R50("ngModel",t.name),e.Y8G("ngModelOptions",e.lJ4(10,oe))("hidden",!t.editMode),e.R7$(2),e.Y8G("hidden",!t.loading),e.R7$(3),e.SpI("",r.formatDistance(t)," "),e.R7$(2),e.Y8G("title",e.bMT(12,8,"TRIP_PLANNER.removeWaypoint"))}}function ce(i,p){1&i&&(e.j41(0,"div",19),e.EFF(1),e.nI1(2,"translateHs"),e.k0s()),2&i&&(e.R7$(),e.SpI(" ",e.bMT(2,1,"TRIP_PLANNER.waypointDrawingHint")," "))}function pe(i,p){if(1&i){const t=e.RV6();e.j41(0,"div",1),e.nrm(1,"hs-panel-header",2),e.nI1(2,"translateHs"),e.j41(3,"div",3),e.nrm(4,"hs-trip-planner-layer-selector",4),e.nI1(5,"translateHs"),e.nrm(6,"hs-trip-planner-layer-selector",5),e.nI1(7,"translateHs"),e.DNE(8,le,14,11,"div",6)(9,ce,3,3,"div",7),e.nrm(10,"br"),e.j41(11,"a",8),e.bIt("click",function(){e.eBV(t);const n=e.XpG();return e.Njj(n.HsTripPlannerService.clearAll())}),e.EFF(12),e.nI1(13,"translateHs"),e.k0s(),e.nrm(14,"br"),e.j41(15,"div",9)(16,"div",10)(17,"strong"),e.EFF(18),e.nI1(19,"translateHs"),e.k0s()(),e.j41(20,"div",11),e.EFF(21),e.k0s()()()()}if(2&i){const t=e.XpG();e.Y8G("ngClass",t.panelWidthClass),e.R7$(),e.Y8G("title",e.bMT(2,11,"PANEL_HEADER.TRIP_PLANNER")),e.R7$(3),e.Y8G("label",e.bMT(5,13,"TRIP_PLANNER.routerLayer"))("selectedWrapper",t.HsTripPlannerService.selectedLayerWrapper.route),e.R7$(2),e.Y8G("label",e.bMT(7,15,"TRIP_PLANNER.waypointLayer"))("selectedWrapper",t.HsTripPlannerService.selectedLayerWrapper.waypoints),e.R7$(2),e.Y8G("ngForOf",t.HsTripPlannerService.waypoints),e.R7$(),e.Y8G("ngIf",0===t.HsTripPlannerService.waypoints.length),e.R7$(3),e.JRh(e.bMT(13,17,"TRIP_PLANNER.clearWaypoints")),e.R7$(6),e.SpI("",e.bMT(19,19,"TRIP_PLANNER.totalDistance"),":"),e.R7$(3),e.JRh(t.totalDistance())}}let de=(()=>{class i extends $.aH{constructor(t,r,n,a,o,l,S){super(),this.HsMapService=t,this.HsCoreService=r,this.HsTripPlannerService=n,this.HsConfig=a,this.HsUtilsService=o,this.HsLayerUtilsService=l,this.hsLanguageService=S,this.name="tripPlanner"}ngOnInit(){var t=()=>super.ngOnInit,r=this;return(0,m.A)(function*(){t().call(r),void 0===r.HsConfig.default_layers?r.HsConfig.default_layers=[]:r.HsConfig.default_layers.push(r.HsTripPlannerService.routeLayer)})()}formatDistance(t){return this.HsTripPlannerService.formatDistance(t)}totalDistance(){let t=0;return this.HsTripPlannerService.waypoints.forEach(r=>{r.routes.from&&(t+=r.routes.from.get("summary").distance/1e3)}),t.toFixed(2)+"km"}toggleEdit(t){t.editMode=!t.editMode;const r=this.HsTripPlannerService.waypointLayer.getSource();(0,y.YD)(r.getFeatureById(t.featureId),t.editMode)}static#e=this.\u0275fac=function(r){return new(r||i)(e.rXU(E.F),e.rXU(ae.A),e.rXU(L),e.rXU(A.Q),e.rXU(f.MJ),e.rXU(f.Xp),e.rXU(M.LJ))};static#t=this.\u0275cmp=e.VBU({type:i,selectors:[["hs-trip-planner"]],features:[e.Vt3],decls:2,vars:3,consts:[["class","card hs-main-panel",3,"ngClass",4,"ngIf"],[1,"card","hs-main-panel",3,"ngClass"],["name","tripPlanner",3,"title"],[1,"card-body"],["usage","route",3,"label","selectedWrapper"],["usage","waypoints",3,"label","selectedWrapper"],["class","d-flex flex-row",4,"ngFor","ngForOf"],["class","alert alert-primary","role","alert",4,"ngIf"],[3,"click"],[1,"d-flex","flex-row"],[1,"p-1","flex-grow-1"],[1,"p-1"],[3,"click","hidden"],[1,"form-control","hs-waypoint-name",3,"ngModelChange","blur","ngModel","ngModelOptions","hidden"],[1,"hs-loader","hs-loader-dark",3,"hidden"],[1,"p-1",2,"height","1.7em"],[2,"margin-top","1em"],["data-toggle","tooltip",1,"p-1",3,"click","title"],[1,"icon-remove-circle",2,"color","rgb(228, 99, 99)"],["role","alert",1,"alert","alert-primary"]],template:function(r,n){1&r&&(e.DNE(0,pe,22,21,"div",0),e.nI1(1,"async")),2&r&&e.Y8G("ngIf",e.bMT(1,1,n.isVisible$))},dependencies:[g.me,g.BC,g.vS,c.YU,c.Sq,c.bT,G,c.Jj,j.q],encapsulation:2})}return i})(),ue=(()=>{class i{static#e=this.\u0275fac=function(r){return new(r||i)};static#t=this.\u0275mod=e.$C({type:i});static#r=this.\u0275inj=e.G2t({imports:[g.YN,c.MD,$.Zz,v.zH]})}return i})()}}]);
//# sourceMappingURL=557.js.map